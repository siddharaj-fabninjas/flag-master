<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlagMaster SRS</title>
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        /* HUD & Stats */
        .hud {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            background: var(--card-bg);
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .stat { font-weight: bold; color: var(--primary); }

        /* Game Container */
        .game-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Flashcard Styling */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        
        .flag-img {
            width: 200px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .country-name {
            font-size: 1.5rem;
            font-weight: 800;
            margin-top: 20px;
            display: none; /* Hidden initially */
        }

        .show-answer-btn {
            margin-top: 30px;
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        /* Rating Buttons */
        .rating-area {
            display: none; /* Hidden initially */
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .rate-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            flex: 1;
            min-width: 80px;
        }

        .btn-again { background-color: #ef4444; } /* Red */
        .btn-hard { background-color: #f59e0b; } /* Orange */
        .btn-good { background-color: #10b981; } /* Green */
        .btn-easy { background-color: #3b82f6; } /* Blue */

        /* Loading & Empty States */
        .loader, .finished-msg {
            font-size: 1.2rem;
            color: #6b7280;
            margin-top: 50px;
        }

    </style>
</head>
<body>

    <div class="hud">
        <span>ðŸ”¥ Streak: <span id="streak" class="stat">0</span></span>
        <span>XP: <span id="xp" class="stat">0</span></span>
        <span>Due: <span id="due-count" class="stat">0</span></span>
    </div>

    <div class="game-container">
        <div id="game-area">
            <div id="card" class="card">
                <img id="flag-img" class="flag-img" src="" alt="Flag">
                <h2 id="country-name" class="country-name">Country Name</h2>
                
                <button id="show-btn" class="show-answer-btn">Show Answer</button>

                <div id="rating-area" class="rating-area">
                    <button class="rate-btn btn-again" onclick="rateCard('again')">Again (1m)</button>
                    <button class="rate-btn btn-hard" onclick="rateCard('hard')">Hard (1d)</button>
                    <button class="rate-btn btn-good" onclick="rateCard('good')">Good (3d)</button>
                    <button class="rate-btn btn-easy" onclick="rateCard('easy')">Easy (7d)</button>
                </div>
            </div>
        </div>
        <div id="message-area" class="finished-msg" style="display: none;"></div>
    </div>

    <script>
        // --- 1. GAME STATE & DATA ---
        let flagsDB = []; // All flag data
        let studyQueue = []; // Cards due for review today
        let currentCard = null;
        let userProgress = {
            xp: 0,
            streak: 0,
            lastLogin: null,
            cards: {} // Key: CountryCode, Value: { interval, nextReview, easeFactor }
        };

        // --- 2. INITIALIZATION ---
        async function initGame() {
            loadProgress();
            updateHUD();
            
            const messageArea = document.getElementById('message-area');
            messageArea.innerText = "Loading flags...";
            messageArea.style.display = "block";
            document.getElementById('game-area').style.display = "none";

            try {
                // Fetch Data from REST Countries API
                const res = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3');
                const data = await res.json();
                
                // Filter only valid entries
                flagsDB = data.filter(d => d.cca3 && d.flags && d.flags.svg);
                
                prepareSession();
            } catch (error) {
                console.error(error);
                messageArea.innerText = "Error loading data. Please refresh.";
            }
        }

        // --- 3. SPACED REPETITION LOGIC ---
        function prepareSession() {
            const today = new Date().setHours(0,0,0,0);
            studyQueue = [];

            // check streak
            if (userProgress.lastLogin !== today) {
                // Logic to increment or reset streak would go here
                userProgress.lastLogin = today;
                saveProgress();
            }

            // 1. Find cards due for review
            flagsDB.forEach(flag => {
                const id = flag.cca3;
                const progress = userProgress.cards[id];

                // If never studied (New) OR due date is today/past
                if (!progress || progress.nextReview <= today) {
                    studyQueue.push(flag);
                }
            });

            // Limit session to 20 cards to prevent burnout (optional)
            // studyQueue = studyQueue.slice(0, 20); 

            renderNextCard();
        }

        function calculateNextReview(rating) {
            // Simplified SM-2 / Leitner Logic
            // Rating: 'again' (fail), 'hard', 'good', 'easy'
            let interval = 1; // days

            if (rating === 'again') {
                interval = 0; // Review again today
            } else if (rating === 'hard') {
                interval = 1;
            } else if (rating === 'good') {
                interval = 3;
            } else if (rating === 'easy') {
                interval = 7;
            }

            // Logic for existing cards (extending intervals)
            if (currentCard && userProgress.cards[currentCard.cca3] && rating !== 'again') {
                const currentInterval = userProgress.cards[currentCard.cca3].interval || 1;
                if (rating === 'easy') interval = Math.round(currentInterval * 2.5);
                if (rating === 'good') interval = Math.round(currentInterval * 1.5);
                if (rating === 'hard') interval = Math.round(currentInterval * 1.2);
            }

            return interval;
        }

        // --- 4. UI INTERACTIONS ---
        function renderNextCard() {
            const gameArea = document.getElementById('game-area');
            const msgArea = document.getElementById('message-area');

            if (studyQueue.length === 0) {
                gameArea.style.display = "none";
                msgArea.style.display = "block";
                msgArea.innerHTML = "ðŸŽ‰ <b>Session Complete!</b><br>You have reviewed all due flags for today.<br>Come back tomorrow!";
                return;
            }

            gameArea.style.display = "block";
            msgArea.style.display = "none";

            // Pop next card
            currentCard = studyQueue[0];
            
            // Reset UI
            document.getElementById('flag-img').src = currentCard.flags.svg;
            document.getElementById('country-name').innerText = currentCard.name.common;
            document.getElementById('country-name').style.display = 'none';
            document.getElementById('rating-area').style.display = 'none';
            document.getElementById('show-btn').style.display = 'inline-block';
            
            updateHUD();
        }

        document.getElementById('show-btn').addEventListener('click', () => {
            document.getElementById('country-name').style.display = 'block';
            document.getElementById('rating-area').style.display = 'flex';
            document.getElementById('show-btn').style.display = 'none';
        });

        function rateCard(rating) {
            const id = currentCard.cca3;
            const interval = calculateNextReview(rating);
            
            // Calculate next date (ms)
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + interval);
            nextDate.setHours(0,0,0,0);

            // Update User Progress
            userProgress.cards[id] = {
                interval: interval,
                nextReview: nextDate.getTime()
            };

            // XP Reward
            if (rating !== 'again') userProgress.xp += 10;
            
            saveProgress();
            
            // Remove from queue if not 'again'
            if (rating !== 'again') {
                studyQueue.shift();
            } else {
                // Move to end of queue to review again this session
                studyQueue.push(studyQueue.shift());
            }

            renderNextCard();
        }

        // --- 5. PERSISTENCE (Local Storage) ---
        function saveProgress() {
            localStorage.setItem('flagMasterProgress', JSON.stringify(userProgress));
            updateHUD();
        }

        function loadProgress() {
            const saved = localStorage.getItem('flagMasterProgress');
            if (saved) {
                userProgress = JSON.parse(saved);
            }
        }

        function updateHUD() {
            document.getElementById('xp').innerText = userProgress.xp;
            document.getElementById('due-count').innerText = studyQueue.length;
            // Streak logic would need refined date checking, simplified here
            document.getElementById('streak').innerText = userProgress.streak; 
        }

        // Start
        initGame();

    </script>
</body>
</html>

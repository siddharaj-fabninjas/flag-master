<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlagMaster SRS</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-hover: #a5b4fc;
            --bg: #111827;
            --card-bg: #1f2937;
            --text: #f9fafb;
            --text-muted: #9ca3af;
            --border: #374151;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Header with Settings */
        .header {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .app-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            margin: 0;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-left,
        .header-right {
            flex-shrink: 0;
        }

        .icon-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: transform 0.2s, background-color 0.2s;
        }

        .icon-btn:hover {
            transform: scale(1.1);
            background: var(--border);
        }

        .icon-btn:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* HUD & Stats */
        .hud {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--card-bg);
            padding: 12px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 6px -1px var(--shadow);
            flex-wrap: wrap;
            justify-content: center;
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .stat { 
            font-weight: bold; 
            color: var(--primary); 
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #10b981);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Game Container */
        .game-container {
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        /* Flashcard Styling */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 10px 15px -3px var(--shadow);
            min-height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px var(--shadow);
        }
        
        .flag-container {
            position: relative;
            width: 100%;
            aspect-ratio: 3 / 2;
            margin-bottom: 20px;
        }

        .flag-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .flag-img.loaded {
            opacity: 1;
        }

        .flag-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 2rem;
        }

        .flag-placeholder.hidden {
            display: none;
        }

        .difficulty-badge {
            display: none;
        }

        .difficulty-badge.tier-1 { background: #10b981; }
        .difficulty-badge.tier-2 { background: #3b82f6; }
        .difficulty-badge.tier-3 { background: #8b5cf6; }
        .difficulty-badge.tier-4 { background: #f59e0b; }
        .difficulty-badge.tier-5 { background: #ef4444; }
        .difficulty-badge.tier-6 { background: #6b7280; }

        .country-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin: 15px 0;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .country-name.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .show-answer-btn {
            margin-top: 20px;
            padding: 14px 28px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        .show-answer-btn:hover {
            background: var(--primary-hover);
            transform: scale(1.02);
        }

        .show-answer-btn:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .show-answer-btn.hidden {
            display: none;
        }

        /* Rating Buttons */
        .rating-area {
            display: none;
            gap: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }

        .rating-area.visible {
            display: flex;
        }

        .rate-btn {
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            flex: 1;
            min-width: 70px;
            max-width: 90px;
            transition: transform 0.2s, filter 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .rate-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .rate-btn:focus {
            outline: 2px solid white;
            outline-offset: 2px;
        }

        .rate-btn .interval {
            font-size: 0.75rem;
            font-weight: normal;
            opacity: 0.9;
        }

        .btn-again { background-color: #ef4444; }
        .btn-hard { background-color: #f59e0b; }
        .btn-good { background-color: #10b981; }
        .btn-easy { background-color: #3b82f6; }

        /* Loading & Empty States */
        .loader, .finished-msg {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-top: 40px;
            text-align: center;
            line-height: 1.6;
        }

        .finished-msg {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 15px -3px var(--shadow);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 350px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 5px;
        }

        .close-btn:hover {
            color: var(--text);
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .setting-description {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
        }

        .setting-input:focus {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        .danger-btn {
            width: 100%;
            padding: 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .danger-btn:hover {
            background: #dc2626;
        }

        .secondary-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .secondary-btn:hover {
            background: var(--primary-hover);
        }

        .advanced-section {
            margin-top: 20px;
            border-top: 1px solid var(--border);
            padding-top: 15px;
        }

        .advanced-toggle {
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-muted);
            padding: 8px 0;
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advanced-toggle::-webkit-details-marker {
            display: none;
        }

        .advanced-toggle::after {
            content: '‚ñ∏';
            transition: transform 0.2s;
        }

        details[open] .advanced-toggle::after {
            transform: rotate(90deg);
        }

        .advanced-toggle:hover {
            color: var(--text);
        }

        .advanced-content {
            margin-top: 15px;
        }

        .import-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }

        .import-status.success {
            display: block;
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .import-status.error {
            display: block;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Keyboard Shortcuts Hint */
        .keyboard-hint {
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .key {
            display: inline-block;
            background: var(--border);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            margin: 0 2px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }

            .header {
                gap: 8px;
            }

            .hud {
                padding: 10px 15px;
                gap: 10px;
            }

            .hud-item {
                font-size: 0.85rem;
            }

            .card {
                padding: 20px 15px;
                min-height: 250px;
            }

            .flag-container {
                width: 100%;
            }

            .country-name {
                font-size: 1.2rem;
            }

            .rate-btn {
                padding: 10px 6px;
                min-width: 60px;
                font-size: 0.9rem;
            }

            .rate-btn .interval {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button id="theme-toggle" class="icon-btn" aria-label="Toggle dark mode" title="Toggle theme (T)">üåô</button>
        </div>
        <h1 class="app-title">üè¥ FlagMaster</h1>
        <div class="header-right">
            <button id="settings-btn" class="icon-btn" aria-label="Open settings" title="Settings (S)">‚öôÔ∏è</button>
        </div>
    </header>

    <!-- HUD Stats -->
    <div class="hud" role="status" aria-live="polite">
        <span class="hud-item">üî• Streak: <span id="streak" class="stat">0</span></span>
        <span class="hud-item">‚≠ê XP: <span id="xp" class="stat">0</span></span>
        <span class="hud-item">üìö Due: <span id="due-count" class="stat">0</span></span>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container" id="progress-container">
        <div class="progress-text">
            <span id="progress-label">Session Progress</span>
            <span id="progress-count">0/0</span>
        </div>
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <!-- Game Area -->
    <main class="game-container">
        <div id="game-area">
            <article id="card" class="card" role="region" aria-label="Flashcard">
                <div class="flag-container">
                    <div id="flag-placeholder" class="flag-placeholder">üè≥Ô∏è</div>
                    <img id="flag-img" class="flag-img" src="" alt="Country flag to identify">
                </div>
                <span id="difficulty-badge" class="difficulty-badge tier-1">Easy</span>
                <h2 id="country-name" class="country-name" aria-live="polite">Country Name</h2>
                
                <button id="show-btn" class="show-answer-btn" aria-describedby="keyboard-hint">
                    Show Answer
                </button>

                <div id="rating-area" class="rating-area" role="group" aria-label="Rate your recall">
                    <button class="rate-btn btn-again" data-rating="again" aria-label="Again - review in 1 minute">
                        Again
                        <span class="interval" id="interval-again">1m</span>
                    </button>
                    <button class="rate-btn btn-hard" data-rating="hard" aria-label="Hard - review later">
                        Hard
                        <span class="interval" id="interval-hard">1d</span>
                    </button>
                    <button class="rate-btn btn-good" data-rating="good" aria-label="Good - review in a few days">
                        Good
                        <span class="interval" id="interval-good">3d</span>
                    </button>
                    <button class="rate-btn btn-easy" data-rating="easy" aria-label="Easy - review in a week">
                        Easy
                        <span class="interval" id="interval-easy">7d</span>
                    </button>
                </div>

                <p class="keyboard-hint" id="keyboard-hint">
                    <span class="key">Space</span> show ¬∑ <span class="key">1-4</span> rate
                </p>
            </article>
        </div>
        <div id="message-area" class="finished-msg" style="display: none;" role="status" aria-live="polite"></div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay" role="dialog" aria-labelledby="modal-title" aria-modal="true">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">‚öôÔ∏è Settings</h2>
                <button id="close-modal" class="close-btn" aria-label="Close settings">&times;</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-value" id="stat-total-studied">0</div>
                    <div class="stat-card-label">Cards Studied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-value" id="stat-mastered">0</div>
                    <div class="stat-card-label">Mastered (7d+)</div>
                </div>
            </div>

            <div class="setting-group">
                <label class="setting-label" for="session-limit">Cards Per Session</label>
                <p class="setting-description">Limit how many new cards to study per session (0 = unlimited)</p>
                <input type="number" id="session-limit" class="setting-input" min="0" max="100" value="20">
            </div>

            <div class="setting-group">
                <label class="setting-label">Reset Progress</label>
                <p class="setting-description">This will clear all your learning progress and stats.</p>
                <button id="reset-btn" class="danger-btn">Reset All Progress</button>
            </div>

            <details class="advanced-section">
                <summary class="advanced-toggle">üîß Advanced Options</summary>
                <div class="advanced-content">
                    <div class="setting-group">
                        <label class="setting-label">Export Data</label>
                        <p class="setting-description">Download all your progress as a JSON file for backup.</p>
                        <button id="export-btn" class="secondary-btn">üì• Export Data</button>
                    </div>

                    <div class="setting-group">
                        <label class="setting-label">Import Data</label>
                        <p class="setting-description">Restore progress from a previously exported JSON file.</p>
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                        <button id="import-btn" class="secondary-btn">üì§ Import Data</button>
                        <div id="import-status" class="import-status"></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script>
        // --- 1. GAME STATE & DATA ---
        let flagsDB = [];
        let studyQueue = [];
        let currentCard = null;
        let sessionTotal = 0;
        let sessionCompleted = 0;

        const DEFAULT_PROGRESS = {
            xp: 0,
            streak: 0,
            lastLoginDate: null,
            sessionLimit: 20,
            cards: {}
        };

        let userProgress = { ...DEFAULT_PROGRESS };

        // --- 2. COUNTRY PRIORITY TIERS ---
        // Tier 1: Most recognizable flags - major world powers, tourist hotspots, distinctive flags
        const TIER_1_COUNTRIES = new Set([
            'USA', 'GBR', 'FRA', 'DEU', 'ITA', 'ESP', 'JPN', 'CHN', 'IND', 'BRA',
            'CAN', 'AUS', 'MEX', 'RUS', 'KOR', 'NLD', 'CHE', 'SWE', 'NOR', 'DNK',
            'GRC', 'TUR', 'EGY', 'ZAF', 'ARG', 'PRT', 'IRL', 'POL', 'AUT', 'BEL',
            'NZL', 'SGP', 'ISR', 'SAU', 'ARE', 'THA', 'VNM', 'IDN', 'MYS', 'PHL',
            'PAK', 'NGA', 'KEN', 'MAR', 'COL', 'PER', 'CHL', 'CUB', 'JAM', 'FIN'
        ]);

        // Tier 2: Well-known countries - significant population or cultural presence
        const TIER_2_COUNTRIES = new Set([
            'UKR', 'CZE', 'HUN', 'ROU', 'BGR', 'HRV', 'SRB', 'SVK', 'SVN', 'LTU',
            'LVA', 'EST', 'ISL', 'LUX', 'MCO', 'VAT', 'MLT', 'CYP', 'BGD', 'LKA',
            'NPL', 'MMR', 'KHM', 'LAO', 'TWN', 'HKG', 'MAC', 'MNG', 'PRK', 'IRN',
            'IRQ', 'SYR', 'JOR', 'LBN', 'QAT', 'KWT', 'OMN', 'BHR', 'YEM', 'AFG',
            'ETH', 'TZA', 'UGA', 'GHA', 'CIV', 'CMR', 'SEN', 'AGO', 'MOZ', 'ZWE',
            'TUN', 'DZA', 'LBY', 'SDN', 'VEN', 'ECU', 'BOL', 'PRY', 'URY', 'PAN',
            'CRI', 'GTM', 'HND', 'SLV', 'NIC', 'DOM', 'HTI', 'PRI', 'TTO', 'BHS'
        ]);

        function getCountryTier(country) {
            const code = country.cca3;
            if (TIER_1_COUNTRIES.has(code)) return 1;
            if (TIER_2_COUNTRIES.has(code)) return 2;
            // Tier 3: By population
            if (country.population > 50000000) return 3;
            if (country.population > 10000000) return 4;
            if (country.population > 1000000) return 5;
            return 6; // Small countries/territories
        }

        function sortByPriority(countries) {
            // Group by tier
            const tiers = {};
            countries.forEach(country => {
                const tier = getCountryTier(country);
                if (!tiers[tier]) tiers[tier] = [];
                tiers[tier].push(country);
            });

            // Shuffle within each tier for variety
            Object.values(tiers).forEach(tierCountries => {
                shuffleArray(tierCountries);
            });

            // Combine tiers in order
            const sorted = [];
            for (let i = 1; i <= 6; i++) {
                if (tiers[i]) {
                    sorted.push(...tiers[i]);
                }
            }
            return sorted;
        }

        // --- 3. UTILITY FUNCTIONS ---
        function getTodayDateString() {
            return new Date().toISOString().split('T')[0];
        }

        function getTodayTimestamp() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today.getTime();
        }

        function formatInterval(days) {
            if (days === 0) return '1m';
            if (days === 1) return '1d';
            if (days < 7) return `${days}d`;
            if (days < 30) return `${Math.round(days / 7)}w`;
            return `${Math.round(days / 30)}mo`;
        }

        // --- 3. INITIALIZATION ---
        async function initGame() {
            loadProgress();
            loadSettings();
            updateHUD();
            
            const messageArea = document.getElementById('message-area');
            messageArea.innerHTML = '<div class="spinner"></div>Loading flags from around the world...';
            messageArea.style.display = 'block';
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('progress-container').style.display = 'none';

            try {
                const res = await fetch('https://restcountries.com/v3.1/all?fields=name,flags,cca3,population');
                
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                const data = await res.json();
                
                // Filter valid entries
                flagsDB = data
                    .filter(d => d.cca3 && d.flags && d.flags.svg && d.name && d.name.common);
                
                if (flagsDB.length === 0) {
                    throw new Error('No valid flag data received');
                }
                
                prepareSession();
            } catch (error) {
                console.error('Failed to load flags:', error);
                messageArea.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 10px;">üòï</div>
                    <strong>Error loading data</strong><br>
                    <span style="font-size: 0.9rem;">${error.message}</span><br><br>
                    <button onclick="location.reload()" class="show-answer-btn">Try Again</button>
                `;
            }
        }

        // --- 4. STREAK LOGIC ---
        function updateStreak() {
            const today = getTodayDateString();
            const lastLogin = userProgress.lastLoginDate;
            
            if (!lastLogin) {
                // First time user
                userProgress.streak = 1;
            } else if (lastLogin === today) {
                // Already logged in today, streak unchanged
                return;
            } else {
                // Check if yesterday
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (lastLogin === yesterdayStr) {
                    // Consecutive day - increment streak
                    userProgress.streak += 1;
                } else {
                    // Streak broken - reset to 1
                    userProgress.streak = 1;
                }
            }
            
            userProgress.lastLoginDate = today;
            saveProgress();
        }

        // --- 5. SPACED REPETITION LOGIC ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function prepareSession() {
            const todayTimestamp = getTodayTimestamp();
            
            // Separate due reviews from new cards
            const dueReviews = [];
            const newCards = [];

            // Update streak on session start
            updateStreak();

            // Categorize cards
            flagsDB.forEach(flag => {
                const id = flag.cca3;
                const progress = userProgress.cards[id];

                if (progress) {
                    // Previously studied card
                    if (progress.nextReview <= todayTimestamp) {
                        dueReviews.push(flag);
                    }
                } else {
                    // New card never studied
                    newCards.push(flag);
                }
            });

            // Sort new cards by priority (famous countries first)
            const prioritizedNewCards = sortByPriority(newCards);
            
            // Shuffle due reviews (user has seen these before)
            shuffleArray(dueReviews);

            // Combine: due reviews first (urgent), then new cards by priority
            studyQueue = [...dueReviews, ...prioritizedNewCards];

            // Apply session limit if set
            const limit = userProgress.sessionLimit;
            if (limit > 0 && studyQueue.length > limit) {
                studyQueue = studyQueue.slice(0, limit);
            }

            sessionTotal = studyQueue.length;
            sessionCompleted = 0;

            updateProgressBar();
            renderNextCard();
        }

        function getRemainingNewCards() {
            // Count cards that haven't been studied yet
            return flagsDB.filter(flag => !userProgress.cards[flag.cca3]).length;
        }

        function startNextSession() {
            // Get cards that haven't been studied yet (new cards)
            const newCards = flagsDB.filter(flag => !userProgress.cards[flag.cca3]);
            
            if (newCards.length === 0) {
                return; // No more cards to learn
            }

            // Sort new cards by priority
            const prioritizedNewCards = sortByPriority(newCards);
            
            // Apply session limit
            const limit = userProgress.sessionLimit;
            if (limit > 0 && prioritizedNewCards.length > limit) {
                studyQueue = prioritizedNewCards.slice(0, limit);
            } else {
                studyQueue = prioritizedNewCards;
            }

            sessionTotal = studyQueue.length;
            sessionCompleted = 0;

            updateProgressBar();
            renderNextCard();
        }

        function calculateNextReview(rating) {
            let interval = 1;

            if (rating === 'again') {
                interval = 0;
            } else if (rating === 'hard') {
                interval = 1;
            } else if (rating === 'good') {
                interval = 3;
            } else if (rating === 'easy') {
                interval = 7;
            }

            // Extend intervals for cards already studied
            if (currentCard && userProgress.cards[currentCard.cca3] && rating !== 'again') {
                const currentInterval = userProgress.cards[currentCard.cca3].interval || 1;
                if (rating === 'easy') interval = Math.round(currentInterval * 2.5);
                else if (rating === 'good') interval = Math.round(currentInterval * 1.8);
                else if (rating === 'hard') interval = Math.round(currentInterval * 1.2);
                
                // Cap at reasonable maximum (6 months)
                interval = Math.min(interval, 180);
            }

            return interval;
        }

        function updateIntervalLabels() {
            if (!currentCard) return;

            const ratings = ['again', 'hard', 'good', 'easy'];
            ratings.forEach(rating => {
                const interval = calculateNextReview(rating);
                const label = document.getElementById(`interval-${rating}`);
                if (label) {
                    label.textContent = formatInterval(interval);
                }
            });
        }

        // --- 6. UI RENDERING ---
        function renderNextCard() {
            const gameArea = document.getElementById('game-area');
            const msgArea = document.getElementById('message-area');
            const progressContainer = document.getElementById('progress-container');

            if (studyQueue.length === 0) {
                gameArea.style.display = 'none';
                progressContainer.style.display = 'none';
                msgArea.style.display = 'block';
                
                const masteredCount = Object.values(userProgress.cards).filter(c => c.interval >= 7).length;
                const remainingCards = getRemainingNewCards();
                
                let continueMessage = '';
                if (remainingCards > 0) {
                    continueMessage = `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                            <span style="color: var(--text-muted);">${remainingCards} more flags available to learn</span><br><br>
                            <button onclick="startNextSession()" class="show-answer-btn">
                                Continue Learning
                            </button>
                        </div>
                    `;
                } else {
                    continueMessage = `<br>Come back tomorrow to review!`;
                }
                
                msgArea.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 15px;">üéâ</div>
                    <strong>Session Complete!</strong><br><br>
                    You reviewed <strong>${sessionCompleted}</strong> flags today.<br>
                    <span style="color: var(--primary);">${masteredCount} flags mastered overall!</span>
                    ${continueMessage}
                `;
                return;
            }

            gameArea.style.display = 'block';
            progressContainer.style.display = 'block';
            msgArea.style.display = 'none';

            currentCard = studyQueue[0];
            
            // Reset UI state
            const flagImg = document.getElementById('flag-img');
            const placeholder = document.getElementById('flag-placeholder');
            const countryName = document.getElementById('country-name');
            const ratingArea = document.getElementById('rating-area');
            const showBtn = document.getElementById('show-btn');
            const difficultyBadge = document.getElementById('difficulty-badge');

            // Update difficulty badge
            const tier = getCountryTier(currentCard);
            const tierLabels = {
                1: 'Famous',
                2: 'Common', 
                3: 'Notable',
                4: 'Moderate',
                5: 'Tricky',
                6: 'Expert'
            };
            difficultyBadge.textContent = tierLabels[tier];
            difficultyBadge.className = `difficulty-badge tier-${tier}`;

            // Show loading state for image
            flagImg.classList.remove('loaded');
            placeholder.classList.remove('hidden');
            
            // Set image with error handling
            flagImg.onload = () => {
                flagImg.classList.add('loaded');
                placeholder.classList.add('hidden');
            };
            flagImg.onerror = () => {
                placeholder.textContent = 'üè≥Ô∏è';
                placeholder.classList.remove('hidden');
                flagImg.classList.remove('loaded');
            };
            
            flagImg.src = currentCard.flags.svg;
            flagImg.alt = `Flag of ${currentCard.name.common} - try to identify this country`;
            
            countryName.textContent = currentCard.name.common;
            countryName.classList.remove('visible');
            ratingArea.classList.remove('visible');
            showBtn.classList.remove('hidden');
            
            updateIntervalLabels();
            updateHUD();
        }

        function showAnswer() {
            document.getElementById('country-name').classList.add('visible');
            document.getElementById('rating-area').classList.add('visible');
            document.getElementById('show-btn').classList.add('hidden');
            
            // Focus first rating button for keyboard navigation
            document.querySelector('.rate-btn').focus();
        }

        function rateCard(rating) {
            const id = currentCard.cca3;
            const interval = calculateNextReview(rating);
            
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + interval);
            nextDate.setHours(0, 0, 0, 0);

            userProgress.cards[id] = {
                interval: interval,
                nextReview: nextDate.getTime(),
                lastReviewed: Date.now()
            };

            // XP reward (bonus for streaks)
            if (rating !== 'again') {
                let xpGain = 10;
                if (rating === 'easy') xpGain = 20;
                else if (rating === 'good') xpGain = 15;
                userProgress.xp += xpGain;
            }
            
            saveProgress();
            
            // Handle queue
            if (rating !== 'again') {
                studyQueue.shift();
                sessionCompleted++;
            } else {
                // Move to end of queue for retry
                studyQueue.push(studyQueue.shift());
            }

            updateProgressBar();
            renderNextCard();
        }

        function updateProgressBar() {
            const fill = document.getElementById('progress-fill');
            const count = document.getElementById('progress-count');
            const container = document.getElementById('progress-container');
            
            if (sessionTotal === 0) {
                container.style.display = 'none';
                return;
            }
            
            const percent = Math.round((sessionCompleted / sessionTotal) * 100);
            fill.style.width = `${percent}%`;
            count.textContent = `${sessionCompleted}/${sessionTotal}`;
            
            // Update aria for accessibility
            fill.parentElement.setAttribute('aria-valuenow', percent);
        }

        // --- 7. PERSISTENCE ---
        function saveProgress() {
            localStorage.setItem('flagMasterProgress', JSON.stringify(userProgress));
            updateHUD();
        }

        function loadProgress() {
            const saved = localStorage.getItem('flagMasterProgress');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    userProgress = { ...DEFAULT_PROGRESS, ...parsed };
                } catch (e) {
                    console.error('Failed to parse saved progress:', e);
                    userProgress = { ...DEFAULT_PROGRESS };
                }
            }
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all your progress? This cannot be undone!')) {
                userProgress = { ...DEFAULT_PROGRESS };
                localStorage.removeItem('flagMasterProgress');
                closeModal();
                prepareSession();
            }
        }

        // --- IMPORT/EXPORT FUNCTIONS ---
        function exportData() {
            const exportData = {
                version: 1,
                exportDate: new Date().toISOString(),
                theme: localStorage.getItem('flagMasterTheme') || 'light',
                progress: userProgress
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `flagmaster-backup-${getTodayDateString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(file) {
            const statusEl = document.getElementById('import-status');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate the data structure
                    if (!data.progress || typeof data.progress !== 'object') {
                        throw new Error('Invalid data format: missing progress data');
                    }

                    // Validate required fields in progress
                    const requiredFields = ['xp', 'streak', 'cards'];
                    for (const field of requiredFields) {
                        if (!(field in data.progress)) {
                            throw new Error(`Invalid data format: missing ${field} field`);
                        }
                    }

                    // Validate cards structure
                    if (typeof data.progress.cards !== 'object') {
                        throw new Error('Invalid data format: cards must be an object');
                    }

                    // Confirm import
                    const cardCount = Object.keys(data.progress.cards).length;
                    const confirmMsg = `This will replace your current progress with:\n‚Ä¢ ${data.progress.xp.toLocaleString()} XP\n‚Ä¢ ${data.progress.streak} day streak\n‚Ä¢ ${cardCount} studied cards\n\nContinue?`;
                    
                    if (!confirm(confirmMsg)) {
                        statusEl.className = 'import-status';
                        statusEl.textContent = '';
                        return;
                    }

                    // Import progress
                    userProgress = { ...DEFAULT_PROGRESS, ...data.progress };
                    saveProgress();

                    // Import theme if present
                    if (data.theme) {
                        localStorage.setItem('flagMasterTheme', data.theme);
                        if (data.theme === 'dark') {
                            document.documentElement.setAttribute('data-theme', 'dark');
                            document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
                        } else {
                            document.documentElement.removeAttribute('data-theme');
                            document.getElementById('theme-toggle').textContent = 'üåô';
                        }
                    }

                    // Update UI
                    statusEl.className = 'import-status success';
                    statusEl.textContent = `‚úì Successfully imported ${cardCount} cards, ${data.progress.xp.toLocaleString()} XP`;
                    
                    // Update settings display
                    document.getElementById('stat-total-studied').textContent = cardCount;
                    const mastered = Object.values(userProgress.cards).filter(c => c.interval >= 7).length;
                    document.getElementById('stat-mastered').textContent = mastered;
                    document.getElementById('session-limit').value = userProgress.sessionLimit || 20;
                    
                    updateHUD();
                    
                    // Refresh session with new data
                    prepareSession();

                } catch (error) {
                    console.error('Import error:', error);
                    statusEl.className = 'import-status error';
                    statusEl.textContent = `‚úó Import failed: ${error.message}`;
                }
            };

            reader.onerror = function() {
                statusEl.className = 'import-status error';
                statusEl.textContent = '‚úó Failed to read file';
            };

            reader.readAsText(file);
        }

        function updateHUD() {
            document.getElementById('xp').textContent = userProgress.xp.toLocaleString();
            document.getElementById('due-count').textContent = studyQueue.length;
            document.getElementById('streak').textContent = userProgress.streak;
        }

        // --- 8. SETTINGS & THEME ---
        function loadSettings() {
            // Load theme
            const savedTheme = localStorage.getItem('flagMasterTheme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è';
            }
            
            // Load session limit
            document.getElementById('session-limit').value = userProgress.sessionLimit || 20;
        }

        function toggleTheme() {
            const html = document.documentElement;
            const themeBtn = document.getElementById('theme-toggle');
            
            if (html.getAttribute('data-theme') === 'dark') {
                html.removeAttribute('data-theme');
                themeBtn.textContent = 'üåô';
                localStorage.setItem('flagMasterTheme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                themeBtn.textContent = '‚òÄÔ∏è';
                localStorage.setItem('flagMasterTheme', 'dark');
            }
        }

        function openModal() {
            const modal = document.getElementById('settings-modal');
            modal.classList.add('visible');
            
            // Update stats
            const totalStudied = Object.keys(userProgress.cards).length;
            const mastered = Object.values(userProgress.cards).filter(c => c.interval >= 7).length;
            
            document.getElementById('stat-total-studied').textContent = totalStudied;
            document.getElementById('stat-mastered').textContent = mastered;
            document.getElementById('session-limit').value = userProgress.sessionLimit || 20;
            
            // Trap focus in modal
            document.getElementById('close-modal').focus();
        }

        function closeModal() {
            document.getElementById('settings-modal').classList.remove('visible');
            // Clear import status message
            const statusEl = document.getElementById('import-status');
            statusEl.className = 'import-status';
            statusEl.textContent = '';
        }

        function saveSessionLimit() {
            const input = document.getElementById('session-limit');
            const value = parseInt(input.value, 10);
            
            if (!isNaN(value) && value >= 0) {
                userProgress.sessionLimit = value;
                saveProgress();
            }
        }

        // --- 9. EVENT LISTENERS ---
        document.getElementById('show-btn').addEventListener('click', showAnswer);
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.getElementById('settings-btn').addEventListener('click', openModal);
        document.getElementById('close-modal').addEventListener('click', closeModal);
        document.getElementById('reset-btn').addEventListener('click', resetProgress);
        document.getElementById('session-limit').addEventListener('change', saveSessionLimit);
        
        // Import/Export listeners
        document.getElementById('export-btn').addEventListener('click', exportData);
        document.getElementById('import-btn').addEventListener('click', () => {
            document.getElementById('import-file').click();
        });
        document.getElementById('import-file').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importData(e.target.files[0]);
                e.target.value = ''; // Reset so same file can be selected again
            }
        });

        // Rating button event delegation
        document.getElementById('rating-area').addEventListener('click', (e) => {
            const btn = e.target.closest('.rate-btn');
            if (btn) {
                rateCard(btn.dataset.rating);
            }
        });

        // Modal close on overlay click
        document.getElementById('settings-modal').addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ignore if typing in input
            if (e.target.tagName === 'INPUT') return;
            
            const modal = document.getElementById('settings-modal');
            
            // Close modal with Escape
            if (e.key === 'Escape' && modal.classList.contains('visible')) {
                closeModal();
                return;
            }
            
            // Don't process game shortcuts if modal is open
            if (modal.classList.contains('visible')) return;
            
            const showBtn = document.getElementById('show-btn');
            const ratingArea = document.getElementById('rating-area');
            
            // Show answer with Space
            if (e.key === ' ' && !showBtn.classList.contains('hidden')) {
                e.preventDefault();
                showAnswer();
                return;
            }
            
            // Rate with number keys
            if (ratingArea.classList.contains('visible')) {
                const ratingMap = { '1': 'again', '2': 'hard', '3': 'good', '4': 'easy' };
                if (ratingMap[e.key]) {
                    e.preventDefault();
                    rateCard(ratingMap[e.key]);
                    return;
                }
            }
            
            // Theme toggle with T
            if (e.key.toLowerCase() === 't') {
                toggleTheme();
                return;
            }
            
            // Settings with S
            if (e.key.toLowerCase() === 's') {
                openModal();
                return;
            }
        });

        // Start the game
        initGame();
    </script>
</body>
</html>
